### 内容提要

* 本章主要讲解了一种机制————同样的url，客户端和服务器之间如何根据客户端的需要发送适当的版本文档给客户端，比如同样在浏览器输入www.baidu.com，那么如果是英国的用户很可能希望收到的收到的是英语版本的网页，而在中国的用户很可能希望收到中文版本的网页，那么服务器是怎么实现根据需要发送不同的版本的呢！于是有了内容协商和转码！所谓内容协商指的是客户端和服务器通过在http报文设置相关首部来告诉对方自己需要什么、可以发送什么等，而转码则是把文档装成其他格式的文档，注意：转码和内容编码及传输编码不一样，后两者是更高层次上的编码！



#### 相关术语

* 变体：单一的一个url，根据用户的不同需要，服务器发送不同版本的响应给用户，我们把这种服务器发送的不同版本的响应称为变体。例如一个网页有英语和中文版本，通过内容协商的方法实现精确发送那个版本的给客户端，这两个版本的网页就是变体。

* 转码：有时根据客户端设备的不同，需要将资源转换成响应的格式的文件以让客户端设备更好的处理资源，这种类似的操作就称作转码。


#### 内容协商技术

* 内容协商技术从实现方式来说有三种：

1、客户端驱动实现方式：客户端发起请求，服务器返回资源可用版本的列表，这种方式实现起来简单，但同时有个问题就是至少需要发送两次请求才能得到自己喜欢的响应（第一次获取列表，第二次才是得到资源），显然会造成时延、浪费带宽。

2、服务器驱动实现方式：这种方式由服务器通过检测客户端发送过来的内容协商首部来主动决定发送相应版本的资源，涉及到著名q值检测技术。这种方式的问题就是，如果客户端的发送过来的相关首部不明确的话，那么就得服务器自己去判断了。

3、透明方式（代理缓存处理）：让代理代替客户端与服务器端进行协商，从而减轻了服务器端的请求压力。

#### 客户端驱动的协商

* 这种方式实际上有两种方法为客户端提供选项：一是发送回一个html文档，里面有到该页面的各种版本的链接和每个版本的描述信息；另一种是发送回HTTP/1.1响应式，使用300 Multiple Choices响应代码。不管怎么样，决定权在客户端。这种方式除了增加时延并且对每个页面都要进行繁琐的多次请求之外，还有个缺点就是需要多个url,比如有个资源www.xxxx.com有英语版本好中文版本，那么在把页面分享给朋友的时候就是这种情况：www.xxx.com/en和www.xxx.com/ch。

#### 服务器驱动的协商

* 我们知道客户端驱动的协商会增加额外的通信量，那么避免这种情况就是让服务器端主动决定发送什么给客户端。但是为了做到这一点，客户端必须发送有关客户偏好的足够信息。以便能够左春准确的决策。服务器通过客户端请求的首部集来获得这方面的信息。相关客户端可以发送给服务器做判断的首部如下：

1、Accept首部集

2、User-Agent

#### 内容协商首部集

* 客户端通过下列首部来描述自己的偏好信息：

``` code
	
	Accept            告知服务器发送何种媒体类型

	Accept-Language   告知服务器发送何种语言

	Accept-Charset    告知服务器发送何种字符集

	Accept-Encoding   告知服务器采用何种编码


```

* Accept首部集和匹配的文档首部集

  || *Accept首部* || *实体首部* ||
  || Accept || Content-Type ||
  || Accept-Language || Content-Language ||
  || Accept-Charset || Content-Type ||
  || Accept-Encoding || Content-Encoding ||